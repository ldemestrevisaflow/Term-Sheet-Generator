name: Generate Term Sheet

on:
  push:
    paths:
      - 'term_sheet_data/ts_*.json'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install python-docx

      - name: Find latest Term Sheet data file
        id: find-file
        run: |
          # Find the most recent JSON file by sorting filenames (which contain ISO timestamps)
          LATEST_FILE=$(ls term_sheet_data/ts_*.json 2>/dev/null | sort -r | head -n 1)
          
          if [ -z "$LATEST_FILE" ]; then
            echo "No Term Sheet data files found!"
            exit 1
          fi
          
          echo "Latest file: $LATEST_FILE"
          echo "TS_FILE=$LATEST_FILE" >> $GITHUB_OUTPUT

      - name: Generate Term Sheet document
        run: |
          echo "Loading Term Sheet data..."
          python generate_term_sheet.py ${{ steps.find-file.outputs.TS_FILE }}
          
          # Verify the file was created
          if [ ! -f "output/generated_TermSheet.docx" ]; then
            echo "ERROR: generated_TermSheet.docx was not created!"
            exit 1
          fi
          
          echo "File created successfully!"
          ls -lh output/generated_TermSheet.docx

      - name: Get timestamp
        id: timestamp
        run: echo "TIMESTAMP=$(date +'%Y%m%d_%H%M%S')" >> $GITHUB_OUTPUT

      - name: Prepare generated document
        run: |
          # Create generated_documents directory if it doesn't exist
          mkdir -p generated_documents
          
          # Copy the generated document with timestamp
          cp output/generated_TermSheet.docx generated_documents/TermSheet_${{ steps.timestamp.outputs.TIMESTAMP }}.docx
          
          # Verify the copy
          if [ ! -f "generated_documents/TermSheet_${{ steps.timestamp.outputs.TIMESTAMP }}.docx" ]; then
            echo "ERROR: Failed to copy file to generated_documents!"
            exit 1
          fi
          
          echo "File copied successfully to: generated_documents/TermSheet_${{ steps.timestamp.outputs.TIMESTAMP }}.docx"
          ls -lh generated_documents/TermSheet_${{ steps.timestamp.outputs.TIMESTAMP }}.docx

      - name: Commit generated Term Sheet to repository
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Add the file
          git add generated_documents/TermSheet_${{ steps.timestamp.outputs.TIMESTAMP }}.docx
          
          # Check if there are changes to commit
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            # Get the company name from the JSON file for the commit message
            SELLER_NAME=$(python -c "import json; data=json.load(open('${{ steps.find-file.outputs.TS_FILE }}')); print(data['seller']['name'])")
            
            git commit -m "Generated Term Sheet at ${{ steps.timestamp.outputs.TIMESTAMP }} for ${SELLER_NAME}"
            git push
            
            echo "Successfully committed and pushed!"
          fi

      - name: Upload Term Sheet as artifact
        uses: actions/upload-artifact@v4
        with:
          name: generated-term-sheet
          path: generated_documents/TermSheet_${{ steps.timestamp.outputs.TIMESTAMP }}.docx

      - name: Create download info
        run: |
          echo "================================"
          echo "TERM SHEET GENERATED SUCCESSFULLY!"
          echo "================================"
          echo "File: generated_documents/TermSheet_${{ steps.timestamp.outputs.TIMESTAMP }}.docx"
          echo "Timestamp: ${{ steps.timestamp.outputs.TIMESTAMP }}"
          echo "================================"

name: Generate Term Sheet with Conditional Logic

on:
  push:
    paths:
      - 'term_sheet_data/*.json'
    branches:
      - main

jobs:
  generate-document:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install python-docx

      - name: Find and process latest JSON
        run: |
          python << 'PYTHON_SCRIPT'
          import json
          import os
          import glob
          from docx import Document
          from docx.shared import Pt, RGBColor
          from docx.enum.text import WD_ALIGN_PARAGRAPH

          # Find latest JSON file
          json_files = sorted(glob.glob('term_sheet_data/*.json'), key=os.path.getmtime, reverse=True)
          
          if not json_files:
              print("âŒ No JSON files found in term_sheet_data/")
              exit(1)
          
          json_file = json_files[0]
          print(f"ðŸ“„ Processing: {json_file}")
          
          with open(json_file, 'r') as f:
              data = json.load(f)
          
          print(f"âœ… JSON loaded successfully")
          
          # Create new document
          doc = Document()
          
          # Title
          title = doc.add_paragraph()
          title_run = title.add_run('TERM SHEET')
          title_run.font.size = Pt(24)
          title_run.font.bold = True
          title.alignment = WD_ALIGN_PARAGRAPH.CENTER
          
          doc.add_paragraph()
          
          # 1. PARTIES
          doc.add_heading('1. PARTIES', level=1)
          seller = data.get('seller', {})
          buyer = data.get('buyer', {})
          target = data.get('targetCompany', {})
          
          doc.add_paragraph(f"Seller: {seller.get('name', 'N/A')} (ABN: {seller.get('abn', 'N/A')})", style='List Bullet')
          doc.add_paragraph(f"Buyer: {buyer.get('name', 'N/A')} (ABN: {buyer.get('abn', 'N/A')})", style='List Bullet')
          doc.add_paragraph(f"Target: {target.get('name', 'N/A')} (ABN: {target.get('abn', 'N/A')})", style='List Bullet')
          
          # 2. TRANSACTION
          doc.add_heading('2. TRANSACTION DETAILS', level=1)
          trans = data.get('transaction', {})
          doc.add_paragraph(f"Purchase Price: A${trans.get('purchasePrice', 0):,.2f}", style='List Bullet')
          if trans.get('depositAmount'):
              doc.add_paragraph(f"Deposit Amount: A${trans.get('depositAmount', 0):,.2f}", style='List Bullet')
          if trans.get('baseNetAssets'):
              doc.add_paragraph(f"Base Net Assets: A${trans.get('baseNetAssets', 0):,.2f}", style='List Bullet')
          
          # 3. KEY DATES
          doc.add_heading('3. KEY DATES', level=1)
          dates = data.get('dates', {})
          doc.add_paragraph(f"Term Sheet Date: {dates.get('termSheetDate', 'N/A')}", style='List Bullet')
          doc.add_paragraph(f"Due Diligence: {dates.get('dueDiligenceDate', 'N/A')}", style='List Bullet')
          doc.add_paragraph(f"Long Form Agreement: {dates.get('longFormDate', 'N/A')}", style='List Bullet')
          doc.add_paragraph(f"Condition Satisfaction: {dates.get('conditionSatisfactionDate', 'N/A')}", style='List Bullet')
          doc.add_paragraph(f"Completion: {dates.get('completionDate', 'N/A')}", style='List Bullet')
          
          # 4. CONDITIONS PRECEDENT
          doc.add_heading('4. CONDITIONS PRECEDENT', level=1)
          conditions = data.get('conditions', {})
          doc.add_paragraph(f"DD Type: {conditions.get('dueDiligenceType', 'N/A')}", style='List Bullet')
          doc.add_paragraph(f"Information Request Timeline: {conditions.get('infoRequestDays', 'N/A')} days", style='List Bullet')
          doc.add_paragraph(f"Access Period: {conditions.get('accessPeriodDays', 'N/A')} days", style='List Bullet')
          if conditions.get('additionalConditions'):
              doc.add_paragraph(f"Other Conditions: {conditions.get('additionalConditions', '')}", style='List Bullet')
          
          # 5. WARRANTIES
          doc.add_heading('5. WARRANTIES & INDEMNITIES', level=1)
          warranties = data.get('warranties', {})
          doc.add_paragraph(f"Structure: {warranties.get('structure', 'N/A')}", style='List Bullet')
          doc.add_paragraph(f"Tax Indemnity: {'Yes' if warranties.get('taxIndemnity') else 'No'}", style='List Bullet')
          if warranties.get('limitations'):
              doc.add_paragraph(f"Limitations: {warranties.get('limitations', '')}", style='List Bullet')
          
          # 6. COMMERCIAL TERMS
          doc.add_heading('6. COMMERCIAL TERMS', level=1)
          commercial = data.get('commercial', {})
          doc.add_paragraph(f"Non-Compete: {commercial.get('nonCompetePeriod', 0)} years", style='List Bullet')
          doc.add_paragraph(f"Non-Solicitation: {commercial.get('nonSolicitationPeriod', 0)} months", style='List Bullet')
          doc.add_paragraph(f"Exclusivity Required: {commercial.get('exclusivityRequired', 'N/A')}", style='List Bullet')
          if commercial.get('exclusivityRequired') == 'yes':
              doc.add_paragraph(f"  - End Date: {commercial.get('exclusivityEndDate', 'N/A')}", style='List Bullet 2')
              doc.add_paragraph(f"  - Liquidated Damages: A${commercial.get('liquidatedDamages', 0):,.2f}", style='List Bullet 2')
          
          # 7. MANAGEMENT
          doc.add_heading('7. MANAGEMENT & KEY PERSONNEL', level=1)
          management = data.get('management', {})
          if management.get('directorsResign'):
              doc.add_paragraph(f"Directors to Resign: {management.get('directorsResign', '')}", style='List Bullet')
          if management.get('directorsNewAgreements'):
              doc.add_paragraph(f"Directors New Agreements: {management.get('directorsNewAgreements', '')}", style='List Bullet')
          if management.get('retentionPersonnel'):
              doc.add_paragraph(f"Retention: {management.get('retentionPersonnel', '')}", style='List Bullet')
          
          # 8. LEGAL
          doc.add_heading('8. LEGAL TERMS', level=1)
          legal = data.get('legal', {})
          doc.add_paragraph(f"Term Sheet Type: {legal.get('termSheetType', 'N/A')}", style='List Bullet')
          doc.add_paragraph(f"Jurisdiction: {legal.get('jurisdiction', 'N/A')}", style='List Bullet')
          doc.add_paragraph(f"Jurisdiction Type: {legal.get('jurisdictionType', 'N/A')}", style='List Bullet')
          doc.add_paragraph(f"Governing Law: {legal.get('governingLaw', 'N/A')}", style='List Bullet')
          
          if legal.get('buyerSignatories'):
              doc.add_paragraph(f"Buyer Signatories: {legal.get('buyerSignatories', '')}", style='List Bullet')
          if legal.get('sellerSignatories'):
              doc.add_paragraph(f"Seller Signatories: {legal.get('sellerSignatories', '')}", style='List Bullet')
          if legal.get('suppliersSchedule'):
              doc.add_paragraph(f"Key Suppliers: {legal.get('suppliersSchedule', '')}", style='List Bullet')
          if legal.get('customersSchedule'):
              doc.add_paragraph(f"Key Customers: {legal.get('customersSchedule', '')}", style='List Bullet')
          
          # Save document
          os.makedirs('generated_documents', exist_ok=True)
          seller_name = seller.get('name', 'TermSheet').replace(' ', '_').replace('/', '_')[:50]
          filename = f"generated_documents/TermSheet_{seller_name}.docx"
          doc.save(filename)
          
          file_size = os.path.getsize(filename)
          print(f"âœ… Document generated successfully!")
          print(f"   File: {filename}")
          print(f"   Size: {file_size:,} bytes")
          PYTHON_SCRIPT

      - name: Commit and push
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Actions"
          git add generated_documents/
          git diff --quiet && git diff --staged --quiet || git commit -m "ðŸ¤– Generated term sheet from JSON"
          git push || echo "No changes to push"

name: Generate Term Sheet from Questionnaire

on:
  push:
    paths:
      - 'term_sheet_data/*.json'

permissions:
  contents: write

jobs:
  generate-term-sheet:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install python-docx

      - name: Get latest submitted data
        id: get_data
        run: |
          LATEST_FILE=$(ls -t term_sheet_data/*.json 2>/dev/null | head -1)
          if [ -z "$LATEST_FILE" ]; then
            echo "No data file found"
            exit 0
          fi
          echo "data_file=$LATEST_FILE" >> $GITHUB_OUTPUT
          echo "File: $LATEST_FILE"

      - name: Generate Term Sheet from Template
        if: steps.get_data.outputs.data_file != ''
        run: |
          python << 'PYTHON_SCRIPT'
          import json
          import sys
          import re
          import glob
          import os
          from datetime import datetime
          from docx import Document
          from docx.shared import Pt, RGBColor
          from docx.enum.text import WD_ALIGN_PARAGRAPH
          
          # Load the submitted data
          with open('${{ steps.get_data.outputs.data_file }}', 'r') as f:
              data = json.load(f)
          
          # Load the template document - find it by pattern
          template_file = None
          doc = None
          
          # Try exact filename first
          if os.path.exists('Term_Sheet_-_Share_Sale__ID_2740_.docx'):
              template_file = 'Term_Sheet_-_Share_Sale__ID_2740_.docx'
              doc = Document(template_file)
              print(f"âœ“ Template loaded: {template_file}")
          else:
              # Try to find any docx file that looks like a template
              docx_files = glob.glob('*.docx')
              docx_files = [f for f in docx_files if 'Term' in f or 'template' in f.lower()]
              
              if docx_files:
                  template_file = docx_files[0]
                  doc = Document(template_file)
                  print(f"âœ“ Template loaded: {template_file}")
              else:
                  # If no template found, try any docx in root
                  docx_files = glob.glob('*.docx')
                  if docx_files:
                      template_file = docx_files[0]
                      doc = Document(template_file)
                      print(f"âœ“ Using template: {template_file}")
                  else:
                      print("âš  No template found, generating basic document")
                      doc = Document()
          
          # Function to replace text in all runs of a paragraph
          def replace_text_in_runs(paragraph, key, value):
              full_text = paragraph.text
              if key in full_text:
                  # Clear all runs
                  for run in paragraph.runs:
                      run.text = ""
                  # Add new text with proper formatting
                  new_run = paragraph.add_run(full_text.replace(key, str(value)))
                  return True
              return False
          
          # Prepare replacement data
          seller_name = data.get('seller', {}).get('name', '[insert Party Name]')
          seller_abn = data.get('seller', {}).get('abn', '[insert ABN]')
          buyer_name = data.get('buyer', {}).get('name', '[insert Party Name]')
          buyer_abn = data.get('buyer', {}).get('abn', '[insert ABN]')
          target_name = data.get('targetCompany', {}).get('name', '[insert name and ABN of company]')
          target_abn = data.get('targetCompany', {}).get('abn', '[Insert ABN]')
          target_acn = data.get('targetCompany', {}).get('acn', '')
          
          purchase_price = data.get('transaction', {}).get('purchasePrice', 0)
          deposit_amount = data.get('transaction', {}).get('depositAmount', 0)
          
          completion_date = data.get('dates', {}).get('completionDate', '[insert date]')
          due_diligence_date = data.get('dates', {}).get('dueDiligenceDate', '[insert date]')
          long_form_date = data.get('dates', {}).get('longFormDate', '[insert date]')
          term_sheet_date = data.get('dates', {}).get('termSheetDate', '[insert date]')
          
          term_sheet_type = data.get('legal', {}).get('termSheetType', 'nonbinding')
          governing_law = data.get('legal', {}).get('governingLaw', 'New South Wales')
          
          non_compete_period = data.get('commercial', {}).get('nonCompetePeriod', '[insert period]')
          
          # Replacement mapping - comprehensive list
          replacements = {
              '[insert name and ABN of company]': f'{target_name} (ABN {target_abn})',
              '[Insert Party 1 Name]': seller_name,
              '[Insert Party 2 Name]': buyer_name,
              '[Insert Party 3 Name]': '[insert Escrow Agent Name]',
              '[insert ABN of Party 1]': seller_abn,
              '[insert ABN of Party 2]': buyer_abn,
              '[insert ABN of Party 3]': '[insert ABN]',
              '[Insert ABN of Party 1]': seller_abn,
              '[insert ABN]': target_abn,
              '[Insert Amount]': f'${purchase_price:,.2f}',
              '[insert amount]': f'${deposit_amount:,.2f}',
              'A$[Insert Amount]': f'A${purchase_price:,.2f}',
              '[insert date]': completion_date,
              '[new south wales]': governing_law.lower(),
              '[New South Wales]': governing_law,
              '[insert period]': f'{non_compete_period} years',
          }
          
          # Replace in all paragraphs
          print("\nðŸ“ Replacing placeholders in paragraphs...")
          replacements_made = 0
          for para_idx, para in enumerate(doc.paragraphs):
              for key, value in replacements.items():
                  if key in para.text:
                      replace_text_in_runs(para, key, value)
                      replacements_made += 1
                      print(f"  âœ“ {key} â†’ {value}")
          
          # Replace in tables
          print("\nðŸ“Š Replacing placeholders in tables...")
          for table_idx, table in enumerate(doc.tables):
              for row_idx, row in enumerate(table.rows):
                  for cell_idx, cell in enumerate(row.cells):
                      for para in cell.paragraphs:
                          for key, value in replacements.items():
                              if key in para.text:
                                  replace_text_in_runs(para, key, value)
                                  replacements_made += 1
                                  print(f"  âœ“ Table {table_idx}: {key} â†’ {value}")
          
          print(f"\nâœ… Total replacements made: {replacements_made}")
          
          # Generate filename with timestamp
          now = datetime.utcnow()
          timestamp = now.strftime("%Y%m%d_%H%M%S")
          filename = f"generated_documents/TS_{timestamp}.docx"
          
          # Ensure directory exists
          os.makedirs("generated_documents", exist_ok=True)
          
          # Save the document
          doc.save(filename)
          print(f"\nâœ“ Term Sheet generated: {filename}")
          
          PYTHON_SCRIPT

      - name: Commit generated document
        if: steps.get_data.outputs.data_file != ''
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add generated_documents/
          git commit -m "Generated Term Sheet from questionnaire data" || echo "No changes to commit"
          git push

      - name: Upload artifact
        if: steps.get_data.outputs.data_file != ''
        uses: actions/upload-artifact@v4
        with:
          name: generated-term-sheet
          path: generated_documents/*.docx
          retention-days: 30

name: Generate Term Sheet

on:
  push:
    paths:
      - 'term_sheet_data/*.json'

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install python-docx

      - name: Find latest JSON file
        id: find_json
        run: |
          # Find the most recent JSON file by sorting filenames (which contain ISO timestamps)
          LATEST_JSON=$(ls -t term_sheet_data/ts_*.json 2>/dev/null | head -1)
          if [ -z "$LATEST_JSON" ]; then
            echo "No JSON files found!"
            exit 1
          fi
          echo "json_file=$LATEST_JSON" >> $GITHUB_OUTPUT
          echo "Found questionnaire: $LATEST_JSON"

      - name: Find template file
        id: find_template
        run: |
          # Find the template - try multiple possible names
          if [ -f "term_sheet_data/Term_Sheet_Template.docx" ]; then
            echo "template_file=term_sheet_data/Term_Sheet_Template.docx" >> $GITHUB_OUTPUT
          elif [ -f "templates/term_sheet_template.docx" ]; then
            echo "template_file=templates/term_sheet_template.docx" >> $GITHUB_OUTPUT
          elif [ -f "Term_Sheet_Template.docx" ]; then
            echo "template_file=Term_Sheet_Template.docx" >> $GITHUB_OUTPUT
          else
            echo "ERROR: Template file not found!"
            ls -la term_sheet_data/
            exit 1
          fi

      - name: Extract company name and generate filename
        id: extract_data
        run: |
          python3 << 'EXTRACT_SCRIPT'
          import json
          import os
          
          json_file = "${{ steps.find_json.outputs.json_file }}"
          
          try:
              with open(json_file, 'r') as f:
                  data = json.load(f)
              
              # Extract company name for output filename
              target_company = data.get('parties', {}).get('targetCompany', {}).get('name', 'TermSheet')
              buyer_name = data.get('parties', {}).get('buyer', {}).get('name', 'Buyer')
              
              # Sanitize for filename
              company_name = target_company.replace(' ', '_').replace('/', '_').replace('\\', '_')
              company_name = ''.join(c for c in company_name if c.isalnum() or c == '_')
              
              print(f"Extracted company name: {target_company}")
              print(f"Sanitized for filename: {company_name}")
              
              # Write to GitHub output
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write(f"company_name={company_name}\n")
                  f.write(f"buyer_name={buyer_name}\n")
          
          except Exception as e:
              print(f"Error extracting data: {e}")
              exit(1)
          EXTRACT_SCRIPT

      - name: Generate Term Sheet
        id: generate
        run: |
          python3 generate_term_sheet_CLEAN.py \
            "${{ steps.find_json.outputs.json_file }}" \
            "${{ steps.find_template.outputs.template_file }}" \
            "generated_documents/TermSheet_${{ steps.extract_data.outputs.company_name }}.docx"

      - name: Check if output file exists
        run: |
          if [ ! -f "generated_documents/TermSheet_${{ steps.extract_data.outputs.company_name }}.docx" ]; then
            echo "ERROR: Output file was not created!"
            ls -la generated_documents/
            exit 1
          fi
          echo "✓ Output file created successfully"
          ls -lh generated_documents/TermSheet_${{ steps.extract_data.outputs.company_name }}.docx

      - name: Commit and push generated document
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Add the generated document
          git add generated_documents/TermSheet_${{ steps.extract_data.outputs.company_name }}.docx
          
          # Commit with company name
          git commit -m "Generated: Term Sheet for ${{ steps.extract_data.outputs.company_name }}" || echo "No changes to commit"
          
          # Push with retry
          git push || git push --force

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: term-sheet-${{ steps.extract_data.outputs.company_name }}
          path: generated_documents/TermSheet_${{ steps.extract_data.outputs.company_name }}.docx
          retention-days: 30

      - name: Create GitHub Release
        if: success()
        run: |
          TIMESTAMP=$(date '+%Y-%m-%d_%H-%M-%S')
          OUTPUT_FILE="generated_documents/TermSheet_${{ steps.extract_data.outputs.company_name }}.docx"
          
          # Create or update release notes
          cat > /tmp/release_notes.md << 'NOTES'
          # Term Sheet Generated
          
          **Company:** ${{ steps.extract_data.outputs.company_name }}
          **Generated:** $TIMESTAMP
          **Template:** ${{ steps.find_template.outputs.template_file }}
          NOTES
          
          echo "✓ Document ready for download from generated_documents/ folder"

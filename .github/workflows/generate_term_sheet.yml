name: Generate Term Sheet with Conditional Logic

on:
  # Manual trigger from GitHub UI
  workflow_dispatch:
    inputs:
      formDataJson:
        description: 'Form data as JSON'
        required: true
        type: string
        default: '{"bindingStatus":"binding","dueDiligenceStructure":"unstructured","depositAmount":500000,"escrowRequired":true,"exclusivityRequired":true,"jurisdiction":"exclusive"}'
  
  # Trigger from webhook (e.g., form submission)
  repository_dispatch:
    types: [generate-term-sheet]

env:
  PYTHON_VERSION: '3.9'

jobs:
  determine-option:
    name: Determine Which Option (1-9)
    runs-on: ubuntu-latest
    
    outputs:
      template_variant: ${{ steps.determine.outputs.template_variant }}
      option_number: ${{ steps.determine.outputs.option_number }}
      binding_status: ${{ steps.determine.outputs.binding_status }}
      description: ${{ steps.determine.outputs.description }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Determine term sheet option
        id: determine
        run: |
          python << 'PYTHON'
          import json
          import sys
          sys.path.insert(0, './scripts')
          from option_selector import determine_term_sheet_option, describe_option
          
          # Get form data from input
          form_data_json = """${{ github.event.inputs.formDataJson }}"""
          if not form_data_json:
              form_data_json = """${{ toJson(github.event.client_payload) }}"""
          
          try:
              form_data = json.loads(form_data_json)
          except json.JSONDecodeError:
              print("❌ Invalid JSON in form data")
              form_data = {}
          
          # Determine which option (1-9)
          result = determine_term_sheet_option(form_data)
          
          # Output for next steps
          print(f"::set-output name=template_variant::{result['template_variant']}")
          print(f"::set-output name=option_number::{result['option_number']}")
          print(f"::set-output name=binding_status::{result['binding_status']}")
          print(f"::set-output name=description::{result['description']}")
          
          # Log for debugging
          print(f"\n{'='*80}")
          print(f"✅ OPTION DETERMINED")
          print(f"{'='*80}")
          print(f"Template Variant: {result['template_variant']}")
          print(f"Option Number:   {result['option_number']}")
          print(f"Binding Status:  {result['binding_status']}")
          print(f"Description:     {result['description']}")
          print(f"{'='*80}\n")
          PYTHON

  generate-document:
    name: Generate Term Sheet Document
    runs-on: ubuntu-latest
    needs: determine-option
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install python-docx
      
      - name: Generate Word document using selected template
        id: generate
        run: |
          python << 'PYTHON'
          import json
          import os
          from docx import Document
          
          # Use the determined template variant from previous job
          template_variant = "${{ needs.determine-option.outputs.template_variant }}"
          option_number = "${{ needs.determine-option.outputs.option_number }}"
          binding_status = "${{ needs.determine-option.outputs.binding_status }}"
          
          # Build template path
          template_path = f"templates/Term_Sheet_{template_variant}.docx"
          
          print(f"Loading template: {template_path}")
          print(f"Option: {option_number}")
          print(f"Status: {binding_status}")
          
          try:
              # Load the template
              doc = Document(template_path)
              
              # TODO: Add your existing placeholder replacement code here
              # Example:
              # for paragraph in doc.paragraphs:
              #     if '<<SELLER_NAME>>' in paragraph.text:
              #         paragraph.text = paragraph.text.replace('<<SELLER_NAME>>', form_data['sellerName'])
              
              # Save the document
              output_file = f"Term_Sheet_{template_variant}.docx"
              doc.save(output_file)
              
              file_size = os.path.getsize(output_file)
              print(f"\n✅ Document generated successfully!")
              print(f"   File: {output_file}")
              print(f"   Size: {file_size} bytes")
              
              # Output for next step
              print(f"::set-output name=filename::{output_file}")
              print(f"::set-output name=size::{file_size}")
              
          except FileNotFoundError:
              print(f"\n❌ ERROR: Template not found!")
              print(f"   Expected: {template_path}")
              print(f"   Option:   {option_number}")
              print(f"   Status:   {binding_status}")
              print(f"\nAvailable templates:")
              for f in os.listdir('templates'):
                  if f.endswith('.docx'):
                      print(f"   - {f}")
              exit(1)
          PYTHON
      
      - name: Upload document artifact
        uses: actions/upload-artifact@v3
        with:
          name: generated-term-sheet
          path: Term_Sheet_*.docx
          retention-days: 30
          if-no-files-found: error

  notify-success:
    name: Notify Success
    runs-on: ubuntu-latest
    needs: [determine-option, generate-document]
    if: success()
    
    steps:
      - name: Create success summary
        run: |
          echo "✅ TERM SHEET GENERATED SUCCESSFULLY!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Details" >> $GITHUB_STEP_SUMMARY
          echo "**Template Variant:** ${{ needs.determine-option.outputs.template_variant }}" >> $GITHUB_STEP_SUMMARY
          echo "**Option Number:** ${{ needs.determine-option.outputs.option_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Description:** ${{ needs.determine-option.outputs.description }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the generated document from Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "2. Review for accuracy" >> $GITHUB_STEP_SUMMARY
          echo "3. Distribute to parties" >> $GITHUB_STEP_SUMMARY

  notify-failure:
    name: Notify Failure
    runs-on: ubuntu-latest
    needs: [determine-option, generate-document]
    if: failure()
    
    steps:
      - name: Create failure summary
        run: |
          echo "❌ TERM SHEET GENERATION FAILED!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Selected Option:** ${{ needs.determine-option.outputs.template_variant }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Troubleshooting" >> $GITHUB_STEP_SUMMARY
          echo "1. Check if template file exists in templates/ folder" >> $GITHUB_STEP_SUMMARY
          echo "2. Verify template filename matches: Term_Sheet_${{ needs.determine-option.outputs.template_variant }}.docx" >> $GITHUB_STEP_SUMMARY
          echo "3. Check workflow logs for details" >> $GITHUB_STEP_SUMMARY
          exit 1
